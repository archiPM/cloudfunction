# 系统架构

## 进程结构
```
主进程（Master）
├── API 服务进程（处理HTTP请求）
├── 项目进程（执行函数）
└── 进程间通信（Queue + Event）
```

## 核心组件

### 1. 环境变量管理器 (core/env.py)
- 负责管理系统级和项目级环境变量
- 支持环境变量的继承和覆盖
- 提供环境变量的动态更新

### 2. 项目管理器 (core/project.py)
- 管理项目的生命周期（创建、启动、停止）
- 处理项目依赖的安装和更新
- 管理项目级虚拟环境
- 提供项目状态监控

### 3. API服务器 (core/server.py)
- 基于 FastAPI 的 HTTP 服务器
- 支持异步请求处理
- 提供中间件和异常处理
- 支持 CORS 和可信主机验证

### 4. API路由 (core/api.py)
- 使用 APIRouter 管理路由
- 提供 RESTful API 接口
- 支持请求参数验证
- 统一的响应格式

### 5. 主进程 (core/master.py)
- 管理子进程的创建和销毁
- 处理进程间通信
- 监控进程状态
- 提供进程级别的错误处理

### 6. 函数执行器 (core/executor.py)
- 支持同步和异步函数执行
- 提供并发控制
- 处理函数超时
- 支持函数热重载

### 7. 函数注册中心 (core/registry.py)
- 使用线程安全的注册机制
- 支持函数的动态注册和注销
- 提供函数元数据管理
- 支持函数版本控制

### 8. 服务器状态管理 (core/state.py)
- 使用单例模式管理全局状态
- 提供线程安全的状态访问
- 管理服务器配置

## 工具类

### 1. 日志系统 (utils/logger.py)
- 支持多级日志记录（DEBUG, INFO, WARNING, ERROR, CRITICAL）
- 提供标准格式和 JSON 格式日志
- 支持日志轮转（最大 10MB，保留 5 个备份）
- 项目级别的日志隔离

### 2. LLM服务 (utils/llm/)
- 支持多种 LLM 服务集成
- 提供统一的接口
- 支持并发控制
- 错误重试机制

### 3. 数据库工具 (utils/db/)
- 数据库连接池管理
- 事务支持
- 查询构建器
- 模型映射

## 配置管理

### 1. 系统配置
- 使用环境变量进行配置（通过 .env 文件）
- 支持服务器配置（HOST, PORT, WORKERS 等）
- 支持日志配置（LOG_LEVEL, ACCESS_LOG 等）

### 2. 项目配置
- 项目级环境变量配置（通过项目目录下的 .env 文件）
- 项目级依赖管理（通过 requirements.txt）
- 项目级虚拟环境配置

## 日志系统

### 1. 日志目录结构
```
logs/
├── projects/                # 项目日志目录
│   ├── project1/           # 项目1的日志
│   │   ├── app.log        # 普通日志
│   │   ├── error.log      # 错误日志
│   │   └── json.log       # JSON格式日志
│   └── project2/          # 项目2的日志
├── server.log             # 服务器日志
├── error.log             # 全局错误日志
└── json.log             # JSON格式日志
```

### 2. 日志功能
- 请求日志记录（API 调用、状态码、响应时间等）
- 错误日志记录（异常信息、堆栈跟踪等）
- 函数执行日志（执行时间、结果等）
- 系统状态日志（进程启动、停止等） 